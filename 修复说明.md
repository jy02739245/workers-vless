# WebSocket 1011 错误修复说明

## 问题
v2rayN 连接时频繁出现：`ws closed: 1011 Reconnection failed`

## 原因
1. 重连失败时使用 1011 错误码（内部错误）
2. 数据类型混乱（ArrayBuffer vs Uint8Array）
3. WebSocket 状态检查不完善
4. 重连时错误地重发旧数据

## 已修复
✅ 将重连失败时的错误码从 1011 改为 1000（正常关闭）  
✅ 统一数据类型为 Uint8Array  
✅ 添加 WebSocket 状态检查，避免重复关闭  
✅ 移除重连时重发数据的逻辑（VLESS 协议不应该在传输层重传）  
✅ 优化退避延迟算法（最大 5 秒）  
✅ 改进心跳和 stall 检测的错误处理  
✅ 支持 SOCKS5 模式的重连  

## 测试建议
1. 部署更新后的代码到 Cloudflare Workers
2. 使用 v2rayN 连接并观察日志
3. 进行长时间连接测试（2-4 小时）
4. 在网络波动时测试稳定性

## 技术细节
- 修改了 `readLoop()`、`reconnect()`、`startTimers()` 和消息处理函数
- 所有修改都向后兼容，不影响现有功能
- 代码已通过语法检查
